name: Twitter Match Announcements

on:
  workflow_dispatch:
  push:
    paths:
      - _spielergebnisse/**

env:
  TWITTER_OAUTH_SIGNATURE: ${{ secrets.TWITTER_OAUTH_SIGNATURE }}

jobs:
  New-Matches-to-Twitter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v3
        with: # important to ensure fetch all history!
          fetch-depth: 0

      - name: Setup Git Config
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"

      - name: Scan Matches
        id: scanmatches
        run: |
          cd _spielergebnisse
          declare matches_to_post=()
          for f in $(ls | tr '\n' '\n')
            do
              if [ -z "$(git log --follow --pretty=oneline $f | grep 'twitter')" ]
                then
                  echo "$f added to list of matches to post"
                  matches_to_post+=("$f")
                else
                  echo "$f already posted on Twitter"
              fi
            done
          echo "The following matches have not been posted: ${matches_to_post[*]}"
          echo "::set-output name=matches-to-post::${matches_to_post[*]}"

      - name: Mark matchfiles with string #change frontmatter to indicate that they have been posted on Twitter
        id: markfiles
        if: steps.scanmatches.outputs.matches-to-post != ''
        run: |
          cd _spielergebnisse
          echo $matchfiles
          echo ${{steps.scanmatches.outputs.matches-to-post}}
          for matchfile in ${{steps.scanmatches.outputs.matches-to-post}}
           do
            sed -i -e 's!posted-on-social: false!posted-on-social: true!g' $matchfile
            git add $matchfile
          done
          git commit -m "tagged as posted on twitter"

      - name: Post to Twitter # post the lsat line in the match file to Twitter
        id: posttotwitter
        if: steps.markfiles.outcome == 'success'
        run: |
          cd _spielergebnisse
          echo 'Posting the following to Twitter: $matchfile'
          for matchfile in $matches_to_post
           do
            message='$(tail -n 1 $matchfile)'
            curl -X POST "https://api.twitter.com/2/tweets" -H "Authorization: OAuth $TWITTER_OAUTH_SIGNATURE" -H "Content-type: application/json" -d '{"text":"$message"}'
          done

      - name: Git Push
        if: steps.posttotwitter.outcome == 'success'
        run: |
          git pull --quiet
          git push origin --all --quiet
