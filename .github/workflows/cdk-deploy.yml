name: CDK Deploy

on:
    push:
        branches:
            - main
            - "**" # All branches
        paths:
            - "lib/**"
            - "lambda/**"
            - "cdk.ts"
            - "cdk.json"
            - "package.json"
            - ".github/workflows/cdk-deploy.yml"

permissions:
    id-token: write # Required for AWS OIDC
    contents: read

jobs:
    deploy:
        name: Deploy CDK Stack
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
                  aws-region: ${{ secrets.AWS_REGION || 'eu-central-1' }}

            - name: Determine environment
              id: env
              run: |
                  if [ "${{ github.ref }}" == "refs/heads/main" ]; then
                    echo "environment=prod" >> $GITHUB_OUTPUT
                    echo "is_main=true" >> $GITHUB_OUTPUT
                  else
                    echo "environment=dev" >> $GITHUB_OUTPUT
                    echo "is_main=false" >> $GITHUB_OUTPUT
                  fi

            - name: CDK Diff
              env:
                  CDK_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
                  CDK_ENVIRONMENT: ${{ steps.env.outputs.environment }}
                  CDK_REGION: ${{ secrets.AWS_REGION || 'eu-central-1' }}
                  SAMS_API_KEY: ${{ secrets.SAMS_API_KEY }}
                  SAMS_SERVER: ${{ secrets.SAMS_SERVER }}
              run: bunx cdk diff

            - name: CDK Deploy
              env:
                  CDK_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
                  CDK_ENVIRONMENT: ${{ steps.env.outputs.environment }}
                  CDK_REGION: ${{ secrets.AWS_REGION || 'eu-central-1' }}
                  SAMS_API_KEY: ${{ secrets.SAMS_API_KEY }}
                  SAMS_SERVER: ${{ secrets.SAMS_SERVER }}
              run: bunx cdk deploy --require-approval never

            - name: Comment deployment info
              if: github.event_name == 'push' && steps.env.outputs.is_main == 'false'
              uses: actions/github-script@v7
              with:
                  script: |
                      const branch = context.ref.replace('refs/heads/', '');
                      const sanitizedBranch = branch.replace(/[^a-zA-Z0-9-]/g, '-').replace(/--+/g, '-').substring(0, 20);
                      const stackName = `SamsApiStack-Dev-${sanitizedBranch}`;

                      github.rest.repos.createCommitComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        commit_sha: context.sha,
                        body: `âœ… **CDK Deployment Successful**\n\n` +
                              `**Environment:** dev\n` +
                              `**Branch:** ${branch}\n` +
                              `**Stack Name:** \`${stackName}\`\n\n` +
                              `ðŸ’¡ Remember to destroy this stack when done:\n` +
                              `\`\`\`bash\n` +
                              `bun run cdk destroy ${stackName}\n` +
                              `\`\`\``
                      });
