name: CDK Deploy

on:
    push:
        branches:
            - main
            - "**" # All branches
        paths:
            - "lib/**"
            - "lambda/**"
            - "cdk.ts"
            - "cdk.json"
            - "package.json"
            - ".github/workflows/cdk-deploy.yml"

permissions:
    id-token: write # Required for AWS OIDC
    contents: write # Required for commenting on commits

jobs:
    deploy:
        name: Deploy CDK Stack
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
                  aws-region: ${{ secrets.AWS_REGION || 'eu-central-1' }}

            - name: Determine environment
              id: env
              run: |
                  if [ "${{ github.ref }}" == "refs/heads/main" ]; then
                    echo "environment=prod" >> $GITHUB_OUTPUT
                    echo "is_main=true" >> $GITHUB_OUTPUT
                  else
                    echo "environment=dev" >> $GITHUB_OUTPUT
                    echo "is_main=false" >> $GITHUB_OUTPUT
                  fi

            - name: CDK Diff
              env:
                  CDK_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
                  CDK_ENVIRONMENT: ${{ steps.env.outputs.environment }}
                  CDK_REGION: ${{ secrets.AWS_REGION || 'eu-central-1' }}
                  SAMS_API_KEY: ${{ secrets.SAMS_API_KEY }}
                  SAMS_SERVER: ${{ secrets.SAMS_SERVER }}
              run: bunx cdk diff

            - name: CDK Deploy
              env:
                  CDK_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
                  CDK_ENVIRONMENT: ${{ steps.env.outputs.environment }}
                  CDK_REGION: ${{ secrets.AWS_REGION || 'eu-central-1' }}
                  SAMS_API_KEY: ${{ secrets.SAMS_API_KEY }}
                  SAMS_SERVER: ${{ secrets.SAMS_SERVER }}
              run: bunx cdk deploy --require-approval never

            - name: Add deployment summary
              if: always()
              run: |
                  BRANCH="${{ github.ref_name }}"
                  SANITIZED=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9-]/-/g' | sed 's/--*/-/g' | cut -c1-20)

                  if [ "${{ steps.env.outputs.is_main }}" == "true" ]; then
                    STACK_NAME="SamsApiStack-Prod"
                    ENV_ICON="ðŸš€"
                    ENV_NAME="Production"
                  else
                    STACK_NAME="SamsApiStack-Dev-${SANITIZED}"
                    ENV_ICON="ðŸ”§"
                    ENV_NAME="Development"
                  fi

                  echo "## ${ENV_ICON} CDK Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Environment** | ${ENV_NAME} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Branch** | \`${BRANCH}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Stack Name** | \`${STACK_NAME}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Region** | ${{ secrets.AWS_REGION || 'eu-central-1' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ steps.env.outputs.is_main }}" == "false" ]; then
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "### ðŸ’¡ Cleanup" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "This stack will be automatically destroyed when the branch is deleted or PR is closed." >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "To manually destroy this stack:" >> $GITHUB_STEP_SUMMARY
                    echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                    echo "bunx cdk destroy ${STACK_NAME}" >> $GITHUB_STEP_SUMMARY
                    echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
                  fi
