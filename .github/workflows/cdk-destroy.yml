name: CDK Destroy on Branch Close

on:
    pull_request:
        types: [closed]
    delete:
        branches:
            - "**"

permissions:
    id-token: write # Required for AWS OIDC
    contents: read

jobs:
    destroy:
        name: Destroy Feature Branch Stack
        runs-on: ubuntu-latest
        # Only run for non-main branches
        if: github.event.ref != 'refs/heads/main' && github.event.pull_request.base.ref != 'main'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: main # Checkout main to get CDK code

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
                  aws-region: ${{ secrets.AWS_REGION || 'eu-central-1' }}

            - name: Determine branch and stack name
              id: branch
              run: |
                  if [ "${{ github.event_name }}" == "delete" ]; then
                    BRANCH="${{ github.event.ref }}"
                  else
                    BRANCH="${{ github.event.pull_request.head.ref }}"
                  fi

                  # Sanitize branch name same way as cdk.ts does
                  SANITIZED=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9-]/-/g' | sed 's/--*/-/g' | cut -c1-20)
                  STACK_NAME="SamsApiStack-Dev-${SANITIZED}"

                  echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
                  echo "stack_name=${STACK_NAME}" >> $GITHUB_OUTPUT

            - name: Check if stack exists
              id: stack_check
              env:
                  AWS_REGION: ${{ secrets.AWS_REGION || 'eu-central-1' }}
              run: |
                  if aws cloudformation describe-stacks --stack-name "${{ steps.branch.outputs.stack_name }}" 2>/dev/null; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi

            - name: Destroy CDK Stack
              if: steps.stack_check.outputs.exists == 'true'
              env:
                  CDK_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
                  CDK_ENVIRONMENT: dev
                  CDK_REGION: ${{ secrets.AWS_REGION || 'eu-central-1' }}
                  SAMS_API_KEY: ${{ secrets.SAMS_API_KEY }}
                  SAMS_SERVER: ${{ secrets.SAMS_SERVER }}
              run: |
                  echo "Destroying stack: ${{ steps.branch.outputs.stack_name }}"
                  bun run cdk destroy "${{ steps.branch.outputs.stack_name }}" --force

            - name: Comment on PR
              if: github.event_name == 'pull_request' && steps.stack_check.outputs.exists == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.payload.pull_request.number,
                        body: `üóëÔ∏è **CDK Stack Destroyed**\n\n` +
                              `Stack \`${{ steps.branch.outputs.stack_name }}\` has been destroyed.\n` +
                              `All AWS resources for branch \`${{ steps.branch.outputs.branch }}\` have been cleaned up.`
                      });

            - name: Skip message
              if: steps.stack_check.outputs.exists == 'false'
              run: |
                  echo "Stack ${{ steps.branch.outputs.stack_name }} does not exist, skipping destroy"
